# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Auto Assign PR

on:
  pull_request:
    types: [opened]

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Auto assign PR creator
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const creator = pr.user.login;
            const currentAssignees = pr.assignees.map(a => a.login);

            if (currentAssignees.length === 0) {
              try {
                console.log(`Assigning PR creator: ${creator}`);
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  assignees: [creator]
                });
              } catch (error) {
                const status = error.status || error.response?.status;
                const errorBody = error.response?.data || error.message || JSON.stringify(error);

                if (status === 422) {
                  // 422エラー: 外部コントリビューターの場合はアサインをスキップ
                  console.log(`Skipping assignment for external contributor: ${creator} (HTTP ${status})`);
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: `⚠️ 外部コントリビューターのため、自動アサインをスキップしました。メンテナーが手動でアサインしてください。`
                  });
                } else {
                  // その他のエラー（パーミッション/APIエラーなど）は報告して再スロー
                  console.error(`Failed to assign PR creator: ${creator}`);
                  console.error(`HTTP Status: ${status}`);
                  console.error(`Error Body: ${JSON.stringify(errorBody)}`);
                  console.error(`PR Number: ${pr.number}`);
                  throw error;
                }
              }
            } else {
              console.log(`Assignees already set: ${currentAssignees.join(', ')}`);
            }

      - name: Auto request reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const currentReviewers = pr.requested_reviewers.map(r => r.login);
            const currentTeamReviewers = pr.requested_teams.map(t => t.slug);

            if (currentReviewers.length === 0 && currentTeamReviewers.length === 0) {
              try {
                console.log('Requesting review from team: developer');
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  team_reviewers: ['developer']
                });
              } catch (error) {
                const status = error.status || error.response?.status;
                const errorBody = error.response?.data || error.message || JSON.stringify(error);
                const teamName = 'developer';

                const shouldSkip =
                  status === 404 || // チームが存在しない/見えない
                  status === 422; // レビュー依頼が不正 (チーム指定不可など)

                if (shouldSkip) {
                  console.warn(`Skipping reviewer request from team: ${teamName}`);
                  console.warn(`PR Number: ${pr.number}`);
                  console.warn(`HTTP Status: ${status}`);
                  console.warn(`Error: ${JSON.stringify(errorBody)}`);

                  const reason =
                    status === 404
                      ? 'チームが存在しない、または参照できません。'
                      : status === 422
                        ? 'チームレビューアーを指定できません。'
                        : '不明な理由です。';

                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: `⚠️ 自動レビュー依頼をスキップしました。team: ${teamName} / HTTP ${status}\n理由: ${reason}\nログを確認し、必要ならメンテナーが手動でレビュー依頼してください。`
                  });
                } else {
                  console.error(`Failed to request reviewers from team: ${teamName}`);
                  console.error(`PR Number: ${pr.number}`);
                  console.error(`HTTP Status: ${status}`);
                  console.error(`Error: ${JSON.stringify(errorBody)}`);
                  console.error(`Caught error: ${error}`);
                  throw error;
                }
              }
            } else {
              const allReviewers = [...currentReviewers, ...currentTeamReviewers.map(t => `team:${t}`)];
              console.log(`Reviewers already set: ${allReviewers.join(', ')}`);
            }
