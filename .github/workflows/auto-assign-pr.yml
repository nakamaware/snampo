# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Auto Assign PR

on:
  pull_request:
    types: [opened]

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Auto assign PR creator and reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const creator = pr.user.login;

            // 現在のassigneesとreviewersを取得
            const currentAssignees = pr.assignees.map(a => a.login);
            const currentReviewers = pr.requested_reviewers.map(r => r.login);
            const currentTeamReviewers = pr.requested_teams.map(t => t.slug);

            // Assigneeを設定（まだ割り当てられていない場合）
            if (currentAssignees.length === 0) {
              console.log(`Assigning PR creator: ${creator}`);
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                assignees: [creator]
              });
            } else {
              console.log(`Assignees already set: ${currentAssignees.join(', ')}`);
            }

            // Reviewerを設定（まだ割り当てられていない場合）
            if (currentReviewers.length === 0 && currentTeamReviewers.length === 0) {
              console.log('Requesting review from team: developer');
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                team_reviewers: ['developer']
              });
            } else {
              const allReviewers = [...currentReviewers, ...currentTeamReviewers.map(t => `team:${t}`)];
              console.log(`Reviewers already set: ${allReviewers.join(', ')}`);
            }
