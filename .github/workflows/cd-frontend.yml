name: CD - Frontend (Build Development Release APK)

on:
  push:
    branches:
      - main
    paths:
      - "frontend/**"
      - ".github/workflows/cd-frontend.yml"
  workflow_dispatch: # 手動実行も可能にする
  # 後で削除
  pull_request:
    branches:
      - feature/100-supports-cd-release-for-android

defaults:
  run:
    working-directory: frontend

jobs:
  build-development-release-apk:
    runs-on: ubuntu-24.04
    environment: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Frontend Setup
        uses: ./.github/actions/setup-frontend
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            frontend/android/.gradle
          key: ${{ runner.os }}-gradle-release-${{ hashFiles('frontend/android/**/*.gradle*', 'frontend/android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-release-

      # 難読化ビルドの実行
      - name: Build APK (Development Release)
        run: |
          flutter build apk --release \
            --obfuscate \
            --split-debug-info=build/app/outputs/symbols \
            --no-tree-shake-icons \
            --dart-define=FLAVOR=${{ secrets.FLAVOR }}
            --dart-define=GOOGLE_MAP_API_KEY=${{ secrets.GOOGLE_MAP_API_KEY }}
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }}

      # 作成されたAPKをGitHub Actionsのアーティファクトとしてアップロード
      - name: Upload APK
        uses: actions/upload-artifact@v6
        with:
          name: development-release-apk
          path: frontend/build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error
          retention-days: 30

      # symbolファイルをGitHub Actionsのアーティファクトとしてアップロード
      - name: Upload Debug Symbols
        uses: actions/upload-artifact@v6
        with:
          name: development-release-symbols
          path: frontend/build/app/outputs/symbols/
          if-no-files-found: error
          retention-days: 30
