name: CI

on:
  push:
    branches:
      - main
      - development
  pull_request: {}

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  backend:
    name: Backend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            backend/.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('backend/pyproject.toml', 'backend/uv.lock') }}

      - name: Install dependencies
        run: uv sync

      - name: Lint (ruff)
        run: uv run ruff check app

      - name: Format check (ruff)
        run: uv run ruff format --check app

      # --- Type check (mypy) (使う場合はコメントアウトを外す) ---
      # - name: Type check (mypy)
      #   # mypy が dev-dependencies に追加されている必要があります
      #   run: uv run mypy app
      # ---------------------------------------------------------

      # --- Test (pytest) (使う場合はコメントアウトを外す) ---
      # - name: Test (pytest)
      #   # pytest が dev-dependencies に追加されている必要があります
      #   run: uv run pytest -q --cov=app --cov-report=xml --cov-report=html
      #
      # - name: Upload coverage reports
      #   uses: codecov/codecov-action@v5
      #   with:
      #     files: ./coverage.xml
      #     flags: backend
      #     name: backend-coverage
      # ---------------------------------------------------------

      # --- OpenAPI 連携（使う場合はコメントアウトを外す） ---
      # - name: Generate OpenAPI schema
      #   run: uv run python -m app.generate_openapi  # 自前のスクリプト想定
      #
      # - name: Generate Dart client from OpenAPI
      #   uses: openapi-generators/openapi-generator-action@v1
      #   with:
      #     generator: dart
      #     input: backend/openapi.json
      #     output: ../frontend/lib/api_client
      #
      # - name: Upload generated Dart client artifact
      #   uses: actions/upload-artifact@v5
      #   with:
      #     name: dart-api-client
      #     path: frontend/lib/api_client
      # ---------------------------------------------------------

  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Cache Flutter deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            frontend/build
          key: ${{ runner.os }}-flutter-${{ hashFiles('frontend/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            frontend/android/.gradle
          key: >-
            ${{ runner.os }}-gradle-${{ hashFiles(
              'frontend/android/**/*.gradle*',
              'frontend/android/gradle/wrapper/gradle-wrapper.properties'
            ) }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Flutter pub get
        run: flutter pub get

      - name: Format check
        run: dart format --set-exit-if-changed .

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      # --- Test (flutter test) (使う場合はコメントアウトを外す) ---
      # - name: Test
      #   run: flutter test --coverage
      #
      # - name: Upload coverage reports
      #   uses: codecov/codecov-action@v5
      #   with:
      #     files: ./coverage/lcov.info
      #     flags: frontend
      #     name: frontend-coverage
      # ---------------------------------------------------------

      - name: Build APK (debug)
        run: flutter build apk --debug --target-platform android-arm64

      - name: Upload APK artifact
        uses: actions/upload-artifact@v5
        with:
          name: flutter-apk-debug
          path: frontend/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  codeql:
    name: CodeQL (Security scan)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['python']  # Dart/Flutter は対象外なので Python のみ

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  docs_lint:
    name: Docs & YAML Lint (Quality)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Markdown lint
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            **/*.md

      - name: YAML lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
