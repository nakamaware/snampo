name: CI

on:
  push:
    branches:
      - main
  pull_request: {}

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'

  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Backend Setup
        uses: ./.github/actions/setup-backend

      - name: Cache Flutter deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            frontend/build
          key: ${{ runner.os }}-flutter-${{ hashFiles('frontend/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            frontend/android/.gradle
          key: >-
            ${{ runner.os }}-gradle-${{ hashFiles(
              'frontend/android/**/*.gradle*',
              'frontend/android/gradle/wrapper/gradle-wrapper.properties'
            ) }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Flutter pub get
        run: flutter pub get

      - name: Format check
        run: dart format --set-exit-if-changed .

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Check API generated code
        run: |
          cd ..
          bash scripts/check-api.sh

      # --- Test (flutter test) (使う場合はコメントアウトを外す) ---
      # - name: Test
      #   run: flutter test --coverage
      #
      # - name: Upload coverage reports
      #   uses: codecov/codecov-action@v5
      #   with:
      #     files: ./coverage/lcov.info
      #     flags: frontend
      #     name: frontend-coverage
      # ---------------------------------------------------------

      - name: Build APK (debug)
        run: flutter build apk --debug --target-platform android-arm64

      - name: Upload APK artifact
        uses: actions/upload-artifact@v5
        with:
          name: flutter-apk-debug
          path: frontend/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7
